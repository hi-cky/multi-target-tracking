name: windows-msvc

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      BUILD_TYPE: Release
      QT_VERSION: 6.6.3 # 如需对齐本地版本可调整
      QT_MODULES: ""
      VCPKG_FEATURE_FLAGS: registries
      VCPKG_DEFAULT_TRIPLET: x64-windows

    steps:
      - uses: actions/checkout@v4

      - name: Install Qt (aqt)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip aqtinstall
          aqt install-qt windows desktop $env:QT_VERSION win64_msvc2019_64 -O C:\Qt

      - name: Install vcpkg (local bootstrap)
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git $env:USERPROFILE\\vcpkg
          & $env:USERPROFILE\\vcpkg\\bootstrap-vcpkg.bat -disableMetrics
          Add-Content $env:GITHUB_ENV \"VCPKG_ROOT=$env:USERPROFILE\\vcpkg\"
          Add-Content $env:GITHUB_ENV \"VCPKG_DEFAULT_TRIPLET=x64-windows\"
          Add-Content $env:GITHUB_PATH $env:USERPROFILE\\vcpkg

      - name: Install from vcpkg.json when present
        if: ${{ hashFiles('vcpkg.json') != '' }}
        shell: pwsh
        run: |
          & $env:VCPKG_ROOT\\vcpkg.exe install --triplet x64-windows --overlay-ports=\"$env:GITHUB_WORKSPACE\\ports\" --overlay-triplets=\"$env:GITHUB_WORKSPACE\\triplets\" --clean-after-build --x-download-metrics
          # 上面 overlay-* 如无则忽略，不影响

      - name: Install libs via vcpkg (fallback when no vcpkg.json)
        # hashFiles 返回空字符串表示文件不存在
        if: ${{ hashFiles('vcpkg.json') == '' }}
        shell: pwsh
        run: |
          $vcpkg = \"$env:USERPROFILE/vcpkg/vcpkg.exe\"
          & $vcpkg install opencv[core,imgproc,imgcodecs,highgui,video]:x64-windows
          & $vcpkg install onnxruntime:x64-windows

      - name: Configure
        run: >
          cmake -S . -B build
          -G "Ninja"
          -DCMAKE_BUILD_TYPE=%BUILD_TYPE%
          -DCMAKE_PREFIX_PATH="C:/Qt/%QT_VERSION%/msvc2019_64"
          -DCMAKE_TOOLCHAIN_FILE=%USERPROFILE%/vcpkg/scripts/buildsystems/vcpkg.cmake
          -DBUILD_TESTING=OFF

      - name: Build
        run: cmake --build build --config %BUILD_TYPE%

      - name: Bundle Qt runtime
        run: |
          set PATH=C:\Qt\%QT_VERSION%\msvc2019_64\bin;%PATH%
          windeployqt --no-translations --no-angle --no-opengl-sw build\output\QtZedDemo.exe

      - name: Copy vcpkg DLLs to output
        run: |
          if (Test-Path "$env:VCPKG_INSTALLATION_ROOT/installed/x64-windows/bin") {
            Copy-Item "$env:VCPKG_INSTALLATION_ROOT/installed/x64-windows/bin/*" -Destination build/output -Force -ErrorAction SilentlyContinue
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QtZedDemo-%BUILD_TYPE%-windows
          path: |
            build/output/QtZedDemo.exe
            build/output/*.dll
