name: windows-msvc

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      BUILD_TYPE: Release
      QT_VERSION: 6.6.3           # 如需对齐本地版本可调整
      QT_MODULES: qtbase qttools qtdeclarative qtshadertools
      VCPKG_FEATURE_FLAGS: registries
      VCPKG_DEFAULT_TRIPLET: x64-windows

    steps:
      - uses: actions/checkout@v4

      - name: Install Qt (aqt)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip aqtinstall
          aqt install-qt windows desktop $env:QT_VERSION win64_msvc2019_64 --modules $env:QT_MODULES -O C:\Qt

      - name: Setup vcpkg
        uses: microsoft/setup-vcpkg@v1
        with:
          vcpkg-json: "${{ github.workspace }}/vcpkg.json"
          triplet: x64-windows
          runVcpkgInstall: true

      - name: Install libs via vcpkg (fallback when no vcpkg.json)
        if: ${{ !exists('vcpkg.json') }}
        run: |
          vcpkg install opencv[core,imgproc,imgcodecs,highgui,video]:x64-windows
          vcpkg install onnxruntime:x64-windows

      - name: Configure
        run: >
          cmake -S . -B build
          -G "Ninja"
          -DCMAKE_BUILD_TYPE=%BUILD_TYPE%
          -DCMAKE_PREFIX_PATH="C:/Qt/%QT_VERSION%/msvc2019_64"
          -DCMAKE_TOOLCHAIN_FILE=%VCPKG_INSTALLATION_ROOT%/scripts/buildsystems/vcpkg.cmake
          -DBUILD_TESTING=OFF

      - name: Build
        run: cmake --build build --config %BUILD_TYPE%

      - name: Bundle Qt runtime
        run: |
          set PATH=C:\Qt\%QT_VERSION%\msvc2019_64\bin;%PATH%
          windeployqt --no-translations --no-angle --no-opengl-sw build\output\QtZedDemo.exe

      - name: Copy vcpkg DLLs to output
        run: |
          if (Test-Path "$env:VCPKG_INSTALLATION_ROOT/installed/x64-windows/bin") {
            Copy-Item "$env:VCPKG_INSTALLATION_ROOT/installed/x64-windows/bin/*" -Destination build/output -Force -ErrorAction SilentlyContinue
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QtZedDemo-%BUILD_TYPE%-windows
          path: |
            build/output/QtZedDemo.exe
            build/output/*.dll
